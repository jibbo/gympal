<!DOCTYPE html>
<html lang="en">
<head>
  <title>Gym Pal</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="HandheldFriendly" content="true" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="GymPal">
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet" />
  <link rel="apple-touch-icon-precomposed" href="ios_icon.png" />
  <link rel="manifest" href="manifest.json">
  <style>
	*{
	  touch-action: manipulation;
	}
	html{
		font-family: 'Bebas Neue', Arial, Verdana, sans-serif;
	}
	html, body {
		height: 100%;
	}
	body {
		background: #333;
		color:white;
		display:flex;
		flex-direction: column;
	}
	main {
		flex: 1;
		margin: 1em auto;
		text-align:center;
	}
	h2{
		font-size:xxx-large;
	}
	header, footer {
		text-align: center;
	}
	header {
		border-bottom:1px solid #ccc;
	}
	footer {
		border-top:1px solid #ccc;
	}
	section{
		margin:1em;
	}
	button {
		background-color:#CFFF04;
		font-size:xx-large;
		font-family: 'Bebas Neue', Arial, Verdana, sans-serif;
		padding:0.5em;
		text-align:center;
		border-radius:0.3em;
		border:none;
		min-width:1em;
		color:black;
		cursor:pointer;
		appearance: none;
		-webkit-appearance:none;
	}
	button:hover, button:active{
		background-color:#EFFF04;
		color:black;
	}
	.round{
		width:3.2em;
		height:3.2em;
		border-radius:50%;
		text-align:center;
		border:2px solid #CFFF04;
		background-color:#333;
		color:#CFFF04;
		font-size: clamp(xx-large,5wv,xxx-large)
	}
	.round:active,.round:hover{
		background-color:#EFFF04;
		color:black;
	}
	.border-dashed{
		border:2px dashed #CFFF04;
	}
	.row{
		display:flex;
		flex-direction:row;
		flex-wrap:wrap;
		gap:1em;
		justify-content:center;
	}
	.col{
		flex:1 1 auto;
		max-width: 3.1em;
		margin:0.3em;
	}
	.size-6{
		min-width:0.8em;
	}
	.hide{
		display:none;
	}
  </style>
</head>
<body>
	<header>
		<h1>GymPal</h1>
	</header>
	<main>
		<section id="audio">
			<audio id="alarmSound">
				<source src="digital_watch_alarm_long.ogg" type="audio/ogg">
				Your browser does not support the audio element.
			</audio>
		</section>
		<section id="output">
			<h2>SETS: <span id="setsSpan"></span></h2>
		</section>
		<section id="input"> 
			<button  onClick="resetSets()">RESET</button>
			<button  onClick="incSets()">+1</button>
		</section>
		<section id="timer">
			<h2>Timer: <span id="timerSpan"></span></h2>
			<div class="row">
				<button class="round col" onClick="startTimer(30)">30 sec</button>
				<button class="round col" onClick="startTimer(60)">1 min</button>
				<button class="round col" onClick="startTimer(90)">1:30 min</button>
				<button class="round col" onClick="startTimer(120)">2 min</button>
				<button class="round col" onClick="startTimer(180)">3 min</button>
				<span id="customTimers"></span>
				<button class="round border-dashed  col" onClick="addTimer()">+</button>
			</div>
			<div style="margin-top:2em">
<!-- 				<button onClick="test()">SUONA</button> -->
				<button onClick="clearTimer()">STOP</button>
				<button id="audioToggle" onClick="toggleAudio()">
					<svg id="speakerWave" class="size-6 hide" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 0 1 0 12.728M16.463 8.288a5.25 5.25 0 0 1 0 7.424M6.75 8.25l4.72-4.72a.75.75 0 0 1 1.28.53v15.88a.75.75 0 0 1-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.009 9.009 0 0 1 2.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75Z" />
					</svg>
					<svg id="speakerNone" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
						<path stroke-linecap="round" stroke-linejoin="round" d="M17.25 9.75 19.5 12m0 0 2.25 2.25M19.5 12l2.25-2.25M19.5 12l-2.25 2.25m-10.5-6 4.72-4.72a.75.75 0 0 1 1.28.53v15.88a.75.75 0 0 1-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.009 9.009 0 0 1 2.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75Z" />
					</svg>
				</button>
			</div>
		</section>
	</main>
	<footer>
		<p>Created with &lt3 by Jibbo</p>
	</footer>
  <script>
	  // HTML elements
	  const setsSpan = document.getElementById("setsSpan"); 
	  const alarm = document.getElementById("alarmSound");
	  const source = alarm.querySelector('source');
	  const timerSpan = document.getElementById("timerSpan");
	  const audioToggle = document.getElementById("audioToggle");
	  const speakerWave = document.getElementById("speakerWave");
	  const speakerNone = document.getElementById("speakerNone");
	  const customTimersContainer = document.getElementById("customTimers");
	  
	  // Browser functionalities
	  const supportsLocalStorage = typeof Storage !== "undefined";

	  // iPhone shit
	  function isIOS() {
		return (/iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.userAgent.includes('Macintosh') && 'ontouchend' in document));
	  }
	  
	  // Sets
	  const stored = supportsLocalStorage ? localStorage.getItem("sets") : null;
	  let sets = stored !== null ? parseInt(stored, 10) : 0;
	  function incSets() {
		  sets++;
		  if (supportsLocalStorage) {
			  localStorage.setItem("sets", sets);
		  }
		  setsSpan.textContent = sets;
	  }
	  function resetSets() {
		  sets=0;
		  if (supportsLocalStorage) {
			  localStorage.setItem("sets", sets);
		  }
		  setsSpan.textContent = sets;
	  }
	  setsSpan.textContent = sets;

	  // Timer
	  let alarmMs = 0;
	  let timerId = -1;

	  function formatSeconds(seconds, suffix) {
		  if(seconds>=60){
			const m = Math.floor(seconds / 60);
			const s = seconds % 60;
			return `${m}:${s.toString().padStart(2, '0')}`+ (suffix == true ? " min": "");
		  }
		  return seconds + (suffix == true ? " sec" : "");
	  }

	  function startTimer(seconds) {
		  alarmMs = seconds * 1000;
		  if(timerId >= 0){
		  	clearInterval(timerId); // prevent multiple timers
		  }
		  timerId = setInterval(() => {
			  alarmMs = alarmMs - 1000;
			  timerSpan.textContent = formatSeconds(alarmMs/1000, true);
			  if (alarmMs <= 0) {
				  clearInterval(timerId);
				  alarm.play();
			  }
		  }, 1000);

		  timerSpan.textContent = formatSeconds(seconds);
	  }
	  
	  function clearTimer() {
		  clearInterval(timerId);
		  alarmMs = 0;
		  timerSpan.textContent = "0:00";
		  alarm.pause();
		  alarm.currentTime = 0;
	  }

	  function addTimer() {
		  let timer = prompt("Timer in seconds");
		  if(timer != null && parseInt(timer) > 0){
			saveCustomTimer(parseInt(timer));
			displayCustomTimer(timer);
		  }
	  }

	  timerSpan.textContent = "0:00";

	  // Custom Timers
	  const storedTimers = supportsLocalStorage ? localStorage.getItem("timers") : [];
	  let customTimers = storedTimers == null ? [] : JSON.parse(storedTimers);

	  function saveCustomTimer(timer){
		if(supportsLocalStorage){
			let list = localStorage.getItem("timers");
			if(list != null){
				list = JSON.parse(list);
				list.push(timer);
			}else{
				list = [timer];
			}
			localStorage.setItem("timers", JSON.stringify(list));
		}
	  }

	  function removeCustomTimer(timer){
		if(supportsLocalStorage){
			let list = localStorage.getItem("timers");
			if(list != null){
				list = JSON.parse(list);
				const index = list.indexOf(timer);
				if(index > -1){
					list.splice(index, 1);
					localStorage.setItem("timers", JSON.stringify(list));
				}
			}
		}
	  }

	  function displayCustomTimer(timer){
		  let button = document.createElement("button");
		  let timerLabel = formatSeconds(timer);
		  button.innerHTML = timerLabel;
		  button.classList.add("round");
		  button.classList.add("col");
		  button.addEventListener("click", ()=>{
			startTimer(timer);
		  });
		  onLongPress(button, ()=>{
			let confirmation = confirm("Delete?")
			if(confirmation){
				removeCustomTimer(timer);
				customTimersContainer.removeChild(button);
			}
			return false;
		  })
		  customTimersContainer.appendChild(button);
	  }

	  customTimers.forEach((item, index) => {
		  displayCustomTimer(item);
	  });

	  // Audio
	  const storedAudio = supportsLocalStorage ? localStorage.getItem("audio") : true;
	  let audioOn = storedAudio == null ? true : storedAudio;
	  if(isIOS()){
		audioOn = false;
	  }

	  function updateAudioToggleBtn(){
		if(audioOn==true){
			speakerNone.classList.add("hide");
			speakerWave.classList.remove("hide");
		} else {
			speakerNone.classList.remove("hide");
			speakerWave.classList.add("hide")
		}
	  }

	  function toggleAudio(){
		audioOn = !audioOn;
		if(supportsLocalStorage){
			localStorage.setItem("audio", audioOn);
		}
		if(audioOn && isIOS()){
			alarm.play();
			//setInterval(()=>{alarm.pause(); alarm.currentTime=0; alarm.load()}, 951);
		}
		updateAudioToggleBtn();
	  }

	  updateAudioToggleBtn();

	  // mobile support
	  function onLongPress(element, callback) {
		let timer;

		element.addEventListener('touchstart', () => {
			timer = setTimeout(() => {
				timer = null;
				callback();
				return false;
			}, 500);
		});

		function cancel() {
			clearTimeout(timer);
		}

		element.addEventListener('touchend', cancel);
		element.addEventListener('touchmove', cancel);
	}

	  // testing
	  function test(){
		alarm.play();
	  }
  </script>
</body>
</html>
